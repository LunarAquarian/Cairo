<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/marked-element/marked-element.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../pwa-15-comment/pwa-15-comment.html">
<link rel="import" href="../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">

<dom-module id="pwa-15-article">
  <template>
    <style is="custom-style">
       :host {
        display: block;
      }

      .viewContainer {
        width: 50%;
        margin: auto;
      }

      .comments {
        margin-top: 50px;
        color: black;
        width: 50%;
        margin: auto;
      }

      paper-material {
        padding: 5px 5px;
        margin-top: 50px;
      }

      .commentTitle {
        display: flex;
        flex-direction: row;
      }

      #commentPix {
        border-radius: 50%;
      }

      #commentUser {
        flex-grow: 2;
        color: burlywood;
      }

      #commentTime {
        text-align: right;
      }

      #talk,
      #commentUser {
        font-family: Arial, Helvetica, sans-serif;
        font-size: 20px;
      }
    </style>
    <firebase-auth id="auth" user="{{user}}">
      <firebase-query id="query" path="/articles/[[articleId]]/comments" data="{{comments}}"></firebase-query>
      <firebase-document path="/articles/[[articleId]]" data="{{article}}"></firebase-document>

      <!--<app-indexeddb-mirror
      key="article-[[articleId]]"
      data="{{articleLive}}"
      persisted-data="{{article}}">
      </app-indexeddb-mirror>-->

      <div class="viewContainer">

        <template is="dom-if" if="[[article]]">
          <h1>[[article.title]]</h1>
          <marked-element markdown="[[article.body]]">
            <div class="markdown-html"></div>
          </marked-element>

          <a href="/">
            <paper-button raised>
              Back
            </paper-button>
          </a>
        </template>

        <template is="dom-if" if="[[!article]]">
          Loading...
        </template>

        <template is="dom-if" if="[[user]]">
          <a href="/edit/[[articleId]]">
            <paper-button raised>
              Edit
            </paper-button>
          </a>
        </template>
      </div>
      <br/>


      <div class="comments">

        <div class="vertical layout">
          <paper-input id="comm" class="flex" placeholder="What's your take on this?"></paper-input>
          <paper-button class="flex" raised on-tap="commentate">Comment</paper-button>
        </div>

        <paper-material elevation="2">
          <h2>Comments</h2>

          <template is="dom-repeat" items="[[comments]]" as="comment" comment-id={{comment.$key}}>
            <div class="commentTitle"><span id="commentUser">[[comment.UserName]]</span> <span id="commentTime"> [[comment.TimeStamp]]</span></div>
            <p id="talk">[[comment.Comment]]</p> <input value="[[comment.$key]]" id="pushId">
            <p>
              <paper-button raised on-tap="upvote">Upvote</paper-button>
              <paper-button raised on-tap="downvote">Downvote</paper-button>
            </p>
            <!--<pwa-15-comment comment-id={{comment.$key}}></pwa-15-comment>     -->
            <hr>
          </template>
        </paper-material>

      </div>


      <input value="[[articleId]]" type="hidden" id="articleId">

  </template>


  <script>
    let counter = 0;
    let counter1 = 0;

    Polymer({
      is: 'pwa-15-article',

      properties: {
        article: {
          type: Object,
          value: null
        },
        comments: {
          type: Object,
          value: null
        }
      },
      upvote: function () {
        var x = this.$$('#pushId').value;
        votePath = this.$.query.ref.child(x);
        this.$.query.ref.child(x).once("value")
          .then(function (snapshot) {
            var upvotes = snapshot.child("Upvotes").val();
            console.log(upvotes);
            console.log("upvoted ", x);
            votePath.update({
              Upvotes: upvotes + 1
            })
          });

      },
      downvote: function () {
        var y = this.$$('#pushId').value;
        var downPath = this.$.query.ref.child(y);
         this.$.query.ref.child(y).once("value")
          .then(function (snapshot) {
            var downvotes = snapshot.child("Downvotes").val();
            console.log(downvotes);
            console.log("downvoted ", y);
            downPath.update({
              Downvotes: downvotes + 1
            })
          });
        
        
      },
      commentate: function () {
        var art = this.$.query.ref.getKey();
        console.log(art);
        var user = firebase.auth().currentUser;
        var dt = new Date();
        var utcDate = dt.toUTCString();
        this.$.query.ref.push({
          UserName: this.user.displayName,
          UserPix: this.user.photoURL,
          Comment: this.$.comm.value,
          TimeStamp: utcDate
        });
        this.$.comm.value = null;
      }
    });
  </script>
</dom-module>